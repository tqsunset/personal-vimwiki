### 오늘 한 프로젝트

- twitter bot 개인 프로젝트



### 오늘의 워크 플로우

---

#### nginx로 리버스 프록시 설정 방법 조사

- 참고 자료
  - [Configuring NGINX and NGINX Plus as a Web Server](https://docs.nginx.com/nginx/admin-guide/web-server/web-server/)
  - [NGINX Reverse Proxy](https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/)
  - How to Set Up an NGINX Reverse Proxy https://youtu.be/B62QSbPhh1s
  - Configure NGINX as a Reverse Proxy https://youtu.be/lZVAI3PqgHc
  - How to Add SSL Encryption to Web Apps Using the Nginx Reverse Proxy https://youtu.be/wQcSql62zRo


- 다음과 같이 /etc/nginx/nginx.conf를 설정했으나 ip 80포트로 접근 시 계속 기존 nginx 페이지로 접속됨. `include /etc/nginx/sites-enabled/*;` 때문에 /etc/nginx/sites-enabled/default 파일에 있는 서버 설정이 기본 적용되기 때문이었다.

```shell
http {

   #(중간의 basic setting은 생략)
   
   include /etc/nginx/conf.d/*.conf;
   include /etc/nginx/sites-enabled/*;
   
   server {
   	listen 80;
   
	proxy_set_header Host $host;	# WAS에 원 요청자와 그 아이피, 거쳐온 프록시들을 헤더로 넘김
    proxy_set_header X-Real-Ip $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

	location / {
	 proxy_pass http://localhost:8890/;	# 80포트로 들어오는 요청을 localhost:8890으로 프록시
	}}}
```

- 따라서 nginx.conf의 서버 블록을 default 로 옮김. WAS의 기본 페이지로 정상적으로 프록시됨.  
- 모든 nginx config 파일은 ~/.nginx 내 원본 파일의 심볼릭 링크로 설정했다.(intellij에서 접근하기 쉽게 하기 위해)



#### nginx로 SSL 설정

- https 설정을 하려고 보니 DNS_PROBE_FINISHED_NXDOMAIN 메세지와 함께 도메인으로 접속이 되지 않는 것을 발견. AWS로 인증서를 받으려고 네임서버와 DNS 설정을 가비아에서 수정한 게 그대로 있었다. 설정을 원복시켜도 정상 접속이 되지 않음. 가비아 안내로는 변경된 네임서버는 적용될 때까지 최대 48시간 걸린다고 한다. 일단 적용이 된 뒤에야 http 설정이 가능할 듯.

- 다행히 한시간 정도 후에 도메인으로 정상접속이 되는 것을 확인할 수 있었다. 

- jetty로 SSL 설정을 하려고 하기 전 certbot으로 인증서 발급을 받았었음. 그때 nginx 옵션 `sudo certbot --nginx`으로 설치를 했었어서 /etc/nginx/sites-enabled/default에 SSL 서버 블록이 이미 설정되어 있었다. 위에서 작성한 서버 블록의 `proxy_set_header` 설정과 `location` 설정만 SSL 서버 블록으로 이동시켜서 다음과 같이 작성 됨.

  ```shell
  server {
  
     # SSL configuration (하단 영문 코멘트들은 모두 포맷으로 자동 생성된 것)
     #
     # listen 443 ssl default_server;
     # listen [::]:443 ssl default_server;
     #
     # Note: You should disable gzip for SSL traffic. (-> 이에 따라 nginx.conf의 gzip on 설정을 코멘트 처리함) 
     # See: https://bugs.debian.org/773332
     #
     # Read up on ssl_ciphers to ensure a secure configuration.
     # See: https://bugs.debian.org/765782
     #
     # Self signed certs generated by the ssl-cert package
     # Don't use them in a production server!
     #
     # include snippets/snakeoil.conf;
  
      listen [::]:443 ssl ipv6only=on; # managed by Certbot
      listen 443 ssl; # managed by Certbot
  
      server_name allmymusicals.shop;
  
      proxy_set_header Host $host;
      proxy_set_header X-Real-Ip $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  
      ssl_certificate /etc/letsencrypt/live/allmymusicals.shop/fullchain.pem; # managed by Certbot
      ssl_certificate_key /etc/letsencrypt/live/allmymusicals.shop/privkey.pem; # managed by Certbot
  
      include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
      ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
  
     location / {
          proxy_pass http://localhost:8890/;
         }
  
  }
  
  server {	
  	# 80 포트로 들어오는 접근을 모두 https 요청으로 리다이렉트.
  	
      if ($host = allmymusicals.shop) {
          return 301 https://$host$request_uri;
      } # managed by Certbot
  
  
     listen 80 ;
     listen [::]:80 ;
      server_name allmymusicals.shop;
      return 404; # managed by Certbot
  
  }
  ```



- 아래와 같이 https가 정상적으로 적용된 것을 볼 수 있었다.

![](https://user-images.githubusercontent.com/67945304/150685650-df45c3c1-1fc8-41e6-9b0f-0ff23e07d4d1.png)

![](https://user-images.githubusercontent.com/67945304/150685722-e95259ca-5a5a-4084-8cb0-2db2e6bdd515.png)

### 오늘 프로젝트에서 배운 것

- 대략적인 nginx 리버스 프록시, SSL 설정 방법. **정리 필요.**

  - directive가 무엇인지, 주요 directive, 리버스 프록시와 SSL 설정 코드 라인별 의미 해석

- nginx 설정 적용 및 재시작 방법

  ```shell
  $ sudo nginx -t		# 설정 파일 검토
  nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
  nginx: configuration file /etc/nginx/nginx.conf test is successful
  $ sudo systemctl restart nginx.service		# 서비스 재시작 
  ```

  

### 프로젝트와 관련 없지만 알게 된 것

- intellij의 Tools - Deployment 메뉴를 이용해서 에디터 상에서 바로 서버 상의 파일에 접근, 수정이 가능하다. 바로 하단의 start SSH session 메뉴를 이용하여 SSH 터미널 세션 윈도우를 열 수도 있다.
- Tools - HTTP Client 메뉴를 이용해서 직접 https 리퀘스트가 가능하다. Postman보다 사용하기가 얼마나 편할지는 아직 모르겠다.



### 내일 할 것

- certbot 이용 시 crontab으로 자동 인증서 갱신작업 예약해둬야하는지 알아보기. 
- 지금까지 작성한 일기의 내일 할 것 리스트에서 안 한 항목들 리스트업 하고 처리. 
- POST 웹훅 리퀘스트 다시 테스트 해보기

